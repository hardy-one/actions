name: Build LobeChat (AMD64)

on:
  workflow_dispatch: # 推荐手动触发
  push:
    branches: [ "main" ]

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/lobehub-official

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      # ============================================================
      # 1. 拉取目标仓库 (lobehub/lobe-chat) 的 dev 分支
      # ============================================================
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: lobehub/lobe-chat
          ref: dev
          path: lobe-chat-src

      # ============================================================
      # 2. 修复 Dockerfile - 添加 patches 目录复制
      # ============================================================
      - name: Fix Dockerfile for pnpm patches
        run: |
          cd lobe-chat-src

          echo "=== 原 Dockerfile 中的相关行 ==="
          grep -n "COPY apps/desktop" Dockerfile || echo "未找到目标行"

          # 在指定行后添加 COPY patches
          sed -i '/COPY apps\/desktop\/src\/main\/package.json/a COPY patches ./patches' Dockerfile

          echo ""
          echo "=== 修改后的 Dockerfile 相关行 ==="
          grep -A 1 "COPY apps/desktop" Dockerfile || echo "显示失败，但修改已完成"

          cd ..


      # ============================================================
      # 3. 修复 TypeScript 类型错误
      # ============================================================
      - name: Fix TypeScript type errors
        run: |
          cd lobe-chat-src

          echo "============================================================"
          echo "修复 1/3: useFetchFilesAndKnowledgeBases 类型定义"
          echo "============================================================"

          FILE1="src/store/agent/slices/knowledge/action.ts"

          if [ ! -f "$FILE1" ]; then
            echo "❌ 文件不存在: $FILE1"
            exit 1
          fi

          # 备份
          cp "$FILE1" "$FILE1.backup"

          echo "修改前:"
          grep -n "useFetchFilesAndKnowledgeBases:" "$FILE1" | head -1 || echo "(未找到或显示失败)"

          # 修改类型定义：agentId: string -> agentId?: string
          sed -i 's/useFetchFilesAndKnowledgeBases: (agentId: string)/useFetchFilesAndKnowledgeBases: (agentId?: string)/' "$FILE1"

          echo "修改后:"
          grep -n "useFetchFilesAndKnowledgeBases:" "$FILE1" | head -1 || echo "(未找到或显示失败)"

          # 验证
          if grep -q "useFetchFilesAndKnowledgeBases: (agentId?: string)" "$FILE1"; then
            echo "✅ 修复成功"
            rm "$FILE1.backup"
          else
            echo "❌ 修复失败，恢复备份"
            mv "$FILE1.backup" "$FILE1"
            exit 1
          fi

          echo ""
          echo "============================================================"
          echo "修复 2/3: action.test.ts 第 282 行缺少参数"
          echo "============================================================"

          FILE2="src/store/agent/slices/knowledge/action.test.ts"

          if [ ! -f "$FILE2" ]; then
            echo "❌ 文件不存在: $FILE2"
            exit 1
          fi

          # 备份
          cp "$FILE2" "$FILE2.backup"

          echo "修改前:"
          sed -n '282p' "$FILE2"

          # 添加参数 'agent-1'
          sed -i "282s/useFetchFilesAndKnowledgeBases()/useFetchFilesAndKnowledgeBases('agent-1')/" "$FILE2"

          echo "修改后:"
          sed -n '282p' "$FILE2"

          # 验证
          if sed -n '282p' "$FILE2" | grep -q "useFetchFilesAndKnowledgeBases('agent-1')"; then
            echo "✅ 修复成功"
            rm "$FILE2.backup"
          else
            echo "❌ 修复失败，恢复备份"
            mv "$FILE2.backup" "$FILE2"
            exit 1
          fi

          echo ""
          echo "============================================================"
          echo "修复 3/3: action.test.ts 第 298 行缺少参数"
          echo "============================================================"

          echo "修改前:"
          sed -n '298p' "$FILE2"

          # 添加参数 'agent-1'
          sed -i "298s/useFetchFilesAndKnowledgeBases()/useFetchFilesAndKnowledgeBases('agent-1')/" "$FILE2"

          echo "修改后:"
          sed -n '298p' "$FILE2"

          # 验证
          if sed -n '298p' "$FILE2" | grep -q "useFetchFilesAndKnowledgeBases('agent-1')"; then
            echo "✅ 修复成功"
          else
            echo "❌ 修复失败"
            exit 1
          fi

          echo ""
          echo "============================================================"
          echo "✅ 所有 TypeScript 类型错误修复完成"
          echo "============================================================"

          cd ..

      # ============================================================
      # 4. 显示所有修改的摘要
      # ============================================================
      - name: Show all fixes summary
        run: |
          cd lobe-chat-src

          echo "============================================================"
          echo "                    修复摘要"
          echo "============================================================"
          echo ""
          echo "1. Dockerfile patches 修复:"
          if grep -q "COPY patches ./patches" Dockerfile; then
            echo "   ✅ 已添加"
          else
            echo "   ❌ 未添加"
          fi

          echo ""
          echo "3. TypeScript 类型错误修复:"
          if grep -q "useFetchFilesAndKnowledgeBases: (agentId?: string)" src/store/agent/slices/knowledge/action.ts; then
            echo "   ✅ 类型定义已修复"
          else
            echo "   ❌ 类型定义未修复"
          fi

          if sed -n '282p' src/store/agent/slices/knowledge/action.test.ts | grep -q "useFetchFilesAndKnowledgeBases('agent-1')"; then
            echo "   ✅ 测试行282已修复"
          else
            echo "   ❌ 测试行282未修复"
          fi

          if sed -n '298p' src/store/agent/slices/knowledge/action.test.ts | grep -q "useFetchFilesAndKnowledgeBases('agent-1')"; then
            echo "   ✅ 测试行298已修复"
          else
            echo "   ❌ 测试行298未修复"
          fi

          echo ""
          echo "============================================================"

          cd ..

      # ============================================================
      # 5. 设置 Docker Buildx
      # ============================================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ============================================================
      # 6. 登录 Docker Hub
      # ============================================================
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ============================================================
      # 7. 构建并推送 Docker 镜像
      # ============================================================
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          # 指向修复后的源代码目录
          context: lobe-chat-src
          file: lobe-chat-src/Dockerfile
          push: true
          # 显式指定只构建 amd64 架构
          platforms: linux/amd64

          # 构建参数 (Better Auth 配置)
          build-args: |
            NEXT_PUBLIC_ENABLE_BETTER_AUTH=1
            NEXT_PUBLIC_ENABLE_NEXT_AUTH=0

          # 标签
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}

          # 使用 GitHub Actions 缓存加速构建
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ============================================================
      # 8. 输出构建结果
      # ============================================================
      - name: Build completed
        run: |
          echo "============================================================"
          echo "                  构建完成！"
          echo "============================================================"
          echo ""
          echo "镜像标签:"
          echo "  - ${{ env.IMAGE_NAME }}:latest"
          echo "  - ${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo ""
          echo "拉取命令:"
          echo "  docker pull ${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "============================================================"
