name: Build LobeChat (Better Auth / AMD64)

on:
  workflow_dispatch: # æ¨èæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ "main" ]

env:
  # ä¿®æ”¹ä¸ºä½ çš„ Docker Hub ç”¨æˆ·å/ä»“åº“å
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/lobehub

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      # 1. æ‹‰å–ç›®æ ‡ä»“åº“ (lobehub/lobe-chat) çš„ dev åˆ†æ”¯
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: lobehub/lobe-chat
          ref: dev
          path: lobe-chat-src # å°†ä»£ç å­˜æ”¾åœ¨å­ç›®å½•ä¸­ï¼Œé¿å…ä¸å½“å‰ workflow æ‰€åœ¨ç›®å½•æ··æ·†

      - name: Fix Dockerfile for pnpm patches
        run: |
          sed -i '/COPY apps\/desktop\/src\/main\/package.json/a COPY patches ./patches' lobe-chat-src/Dockerfile
      
      # ğŸ†• ä¿®å¤é¦–é¡µæ¶ˆæ¯å‘é€ç¼ºå°‘ await çš„é—®é¢˜
      - name: Fix home sendMessage missing await
        run: |
          FILE="lobe-chat-src/src/app/[variants]/(main)/home/features/InputArea/useSend.ts"
          
          # ä½¿ç”¨æ›´ç²¾ç¡®çš„å¤šè¡ŒåŒ¹é…ï¼Œåªä¿®æ”¹ default åˆ†æ”¯ä¸­çš„ sendMessage
          sed -i '/default: {/,/router\.push/ {
            s/^\(\s*\)sendMessage({$/\1await sendMessage({/
          }' "$FILE"
          
          # éªŒè¯ä¿®æ”¹
          echo "=== éªŒè¯ä¿®æ”¹ç»“æœ ==="
          if grep -q "await sendMessage({" "$FILE"; then
            echo "âœ… ä¿®å¤æˆåŠŸï¼"
            grep -B 2 -A 10 "await sendMessage({" "$FILE"
          else
            echo "âŒ ä¿®å¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹"
            exit 1
          fi

      # 2. è®¾ç½® Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. ç™»å½• Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          # å…³é”®ä¿®æ”¹ï¼šå°†ä¸Šä¸‹æ–‡(context)æŒ‡å‘æ‹‰å–çš„æºä»£ç ç›®å½•
          context: lobe-chat-src
          # å…³é”®ä¿®æ”¹ï¼šæŒ‡å®šè¯¥ç›®å½•ä¸‹çš„ Dockerfile
          file: lobe-chat-src/Dockerfile
          push: true
          # æ˜¾å¼æŒ‡å®šåªæ„å»º amd64
          platforms: linux/amd64
          
          # æ˜¾å¼è®¾ç½®æ„å»ºå‚æ•° (Build Args)
          # æ³¨æ„ï¼šLobeChat çš„ Dockerfile å¿…é¡»æ”¯æŒè¿™äº› ARGS æ‰èƒ½ç”Ÿæ•ˆ
          build-args: |
            NEXT_PUBLIC_ENABLE_BETTER_AUTH=1
            NEXT_PUBLIC_ENABLE_NEXT_AUTH=0
            
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
            
          # ä½¿ç”¨ GitHub Actions ç¼“å­˜åŠ é€Ÿæ„å»º
          cache-from: type=gha
          cache-to: type=gha,mode=max
