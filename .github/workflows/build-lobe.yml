name: Build LobeChat (AMD64)

on:
  workflow_dispatch: # 推荐手动触发
  push:
    branches: [ "main" ]

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/lobehub

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      # ============================================================
      # 1. 拉取目标仓库 (lobehub/lobe-chat) 的 dev 分支
      # ============================================================
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: lobehub/lobe-chat
          ref: next
          path: lobe-chat-src

      # # ============================================================
      # # 2. 修复 Dockerfile - 添加 patches 目录复制
      # # ============================================================
      # - name: Fix Dockerfile for pnpm patches
      #   run: |
      #     cd lobe-chat-src

      #     echo "=== 原 Dockerfile 中的相关行 ==="
      #     grep -n "COPY apps/desktop" Dockerfile || echo "未找到目标行"

      #     # 在指定行后添加 COPY patches
      #     sed -i '/COPY apps\/desktop\/src\/main\/package.json/a COPY patches ./patches' Dockerfile

      #     echo ""
      #     echo "=== 修改后的 Dockerfile 相关行 ==="
      #     grep -A 1 "COPY apps/desktop" Dockerfile || echo "显示失败，但修改已完成"

      #     cd ..

      # ============================================================
      # 3. 设置 Docker Buildx
      # ============================================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ============================================================
      # 4. 登录 Docker Hub
      # ============================================================
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ============================================================
      # 5. 构建并推送 Docker 镜像
      # ============================================================
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          # 指向修复后的源代码目录
          context: lobe-chat-src
          file: lobe-chat-src/Dockerfile
          push: true
          # 显式指定只构建 amd64 架构
          platforms: linux/amd64

          # 构建参数 (Better Auth 配置)
          build-args: |
            NEXT_PUBLIC_ENABLE_BETTER_AUTH=0
            NEXT_PUBLIC_ENABLE_NEXT_AUTH=1

          # 标签
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}

          # 使用 GitHub Actions 缓存加速构建
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ============================================================
      # 6. 输出构建结果
      # ============================================================
      - name: Build completed
        run: |
          echo "============================================================"
          echo "                  构建完成！"
          echo "============================================================"
          echo ""
          echo "镜像标签:"
          echo "  - ${{ env.IMAGE_NAME }}:latest"
          echo "  - ${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo ""
          echo "拉取命令:"
          echo "  docker pull ${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "============================================================"
