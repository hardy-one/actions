name: Build LobeChat (Better Auth / AMD64)

on:
  workflow_dispatch: # 推荐手动触发
  push:
    branches: [ "main" ]

env:
  # 修改为你的 Docker Hub 用户名/仓库名
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/lobehub

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取目标仓库 (lobehub/lobe-chat) 的 dev 分支
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: lobehub/lobe-chat
          ref: next
          path: lobe-chat-src # 将代码存放在子目录中，避免与当前 workflow 所在目录混淆

      # 2. 设置 Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. 登录 Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. 构建并推送 Docker 镜像
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          # 关键修改：将上下文(context)指向拉取的源代码目录
          context: lobe-chat-src
          # 关键修改：指定该目录下的 Dockerfile
          file: lobe-chat-src/Dockerfile
          push: true
          # 显式指定只构建 amd64
          platforms: linux/amd64
          
          # 显式设置构建参数 (Build Args)
          # 注意：LobeChat 的 Dockerfile 必须支持这些 ARGS 才能生效
          build-args: |
            NEXT_PUBLIC_ENABLE_BETTER_AUTH=1
            NEXT_PUBLIC_ENABLE_NEXT_AUTH=0
            
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
            
          # 使用 GitHub Actions 缓存加速构建
          cache-from: type=gha
          cache-to: type=gha,mode=max
